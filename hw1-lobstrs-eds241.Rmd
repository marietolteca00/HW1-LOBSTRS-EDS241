---
title: "Assignment 1"
subtitle: "California Spiny Lobster (*Panulirus Interruptus*): Assessing the Impact of Marine Protected Areas (MPAs) at 5 Reef Sites in Santa Barbara County" 
author: "Marie Tolteca - EDS 241 / ESM 244 (**Due: 1/17**)"
date: "1/17/26"
output: 
    html_document:
      theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=FALSE, warning = FALSE, message = FALSE )
```

------------------------------------------------------------------------

![](figures/spiny2.jpg)

------------------------------------------------------------------------

### Assignment Instructions:

-  Working with partners to troubleshoot code and concepts is encouraged! If you work with a partner, please list their name next to yours at the top of your assignment so Annie and I can easily see who collaborated. 

-  All written responses must be written independently (**in your own words**). 

-  Please follow the question prompts carefully and include only the information each question asks in your submitted responses.

-  Submit both your knitted document and the associated `RMarkdown` or `Quarto` file. 

-  Your knitted presentation should meet the quality you'd submit to research colleagues or feel confident sharing publicly. Refer to the rubric for details about presentation standards.


**Assignment submission (Marie Tolteca):** ______________________________________


----------------------------------------------------------------------

```{r}

library(tidyverse)
library(here)
library(janitor)
library(estimatr)  
library(performance)
library(jtools)
library(gt)
library(gtsummary)
library(interactions) 
library(ggridges)
library(beeswarm)

```

------------------------------------------------------------------------

#### DATA SOURCE:

> [Reed D. 2019. SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012. Environmental Data Initiative.](https://doi.org/10.6073/pasta/a593a675d644fdefb736750b291579a0) Data accessed 11/17/2019.

------------------------------------------------------------------------

### **Introduction**

You're about to dive into some deep data collected from five reef sites in Santa Barbara County, all about the abundance of California spiny lobsters! ðŸ¦ž Data was gathered by divers annually from 2012 to 2018 across Naples, Mohawk, Isla Vista, Carpinteria, and Arroyo Quemado reefs.

Why lobsters? Well, this sample provides an opportunity to evaluate the impact of Marine Protected Areas (MPAs) established on January 1, 2012 (Reed, 2019). Of these five reefs, Naples, and Isla Vista are MPAs, while the other three are not protected (non-MPAs). Comparing lobster health between these protected and non-protected areas gives us the chance to study how commercial and recreational fishing might impact these ecosystems.

We will consider the MPA sites the `treatment` group and use regression methods to explore whether protecting these reefs really makes a difference compared to non-MPA sites (our control group). In this assignment, weâ€™ll think deeply about which causal inference assumptions hold up under the research design and identify where they fall short. 

Letâ€™s break it down step by step and see what the data reveals! ðŸ“Š

![](figures/map-5reefs.png)


------------------------------------------------------------------------

#### Step 1: Anticipating potential sources of selection bias

**a.** Do the control sites (Arroyo Quemado, Carpenteria, and Mohawk) provide a strong counterfactual for our treatment sites (Naples, Isla Vista)? Write a paragraph making a case for why this comparison is ceteris paribus or whether selection bias is likely (be specific!).  

From the image above, I believe this may be selection bias. The reason is because we have more information on the control sites with a total of 3 sites and only 2 control sites. The location of the control sites are close in proximity whereas the control sites are more scattered.

------------------------------------------------------------------------

#### Step 2: Read & wrangle data

**a.** Read in the raw data from the "data" folder named `spiny_abundance_sb_18.csv`. Name the data.frame `rawdata`

**b.** Use the function `clean_names()` from the `janitor` package

```{r}
# HINT: check for coding of missing values (`na = "-99999"`)

rawdata <- read_csv(here('data','spiny_abundance_sb_18.csv'), na = '-99999') %>% 
    clean_names()

```

**c.** Create a new `df` named `tidyata`. Using the variable `site` (reef location) create a new variable `reef` as a `factor` and add the following labels in the order listed (i.e., re-order the `levels`): 
    
    "Arroyo Quemado", "Carpenteria", "Mohawk", "Isla Vista",  "Naples"

# FIX 

```{r}
# FIX
tidydata <- rawdata %>% 
    mutate(reef = case_when(
        site == "AQUE" ~ "Arroyo Quemado",
        site == "CARP" ~ "Carpenteria",
        site == "MOHK" ~ "Mohawk",
        site == "IVEE" ~ "Isla Vista",
        site == "NAPL" ~ "Naples"),
        reef = factor(reef,
                      levels = c("Arroyo Quemado","Carpenteria","Mohawk", "Isla Vista","Naples")))
```

Create new `df` named `spiny_counts` 
```{r}
spiny_counts <- tidydata

```


**d.** Create a new variable `counts` to allow for an analysis of lobster counts where the unit-level of observation is the total number of observed lobsters per `site`, `year` and `transect`. 

- Create a variable `mean_size` from the variable `size_mm`
- NOTE: The variable `counts` should have values which are integers (whole numbers). 
- Make sure to account for missing cases (`na`)!

**e.** Create a new variable `mpa` with levels `MPA` and `non_MPA`. For our regression analysis create a numerical variable `treat` where MPA sites are coded `1` and non_MPA sites are coded `0`

```{r}
#HINT(d): Use `group_by()` & `summarize()` to provide the total number of lobsters observed at each site-year-transect row-observation. 

count <- tidydata %>% 
    group_by(year, site, transect) %>% 
    summarize(num_lobsters = sum(count,na.rm=TRUE), 
              mean_size = mean(size_mm,na.rm=TRUE), 
              .groups = "drop")

#HINT(e): Use `case_when()` to create the 3 new variable columns

spiny_counts <- count %>% 
    mutate(
        mpa = case_when(
            site %in% c('IVEE','NAPL') ~ "MPA",
            site %in% c('AQUE', 'CARP', 'MOHK') ~ "non_MPA"),
        treat = case_when(
            site %in% c('IVEE','NAPL') ~ 1,
            site %in% c('AQUE', 'CARP', 'MOHK')  ~ 0 
        ))
```

> NOTE: This step is crucial to the analysis. Check with a friend or come to TA/instructor office hours to make sure the counts are coded correctly!

------------------------------------------------------------------------

#### Step 3: Explore & visualize data

**a.** Take a look at the data! Get familiar with the data in each `df` format (`tidydata`, `spiny_counts`)

**b.** We will focus on the variables `count`, `year`, `site`, and `treat`(`mpa`) to model lobster abundance. Create the following 4 plots using a different method each time from the 6 options provided. Add a layer (`geom`) to each of the plots including informative descriptive statistics (you choose; e.g., mean, median, SD, quartiles, range). Make sure each plot dimension is clearly labeled (e.g., axes, groups).

- [Density plot](https://r-charts.com/distribution/density-plot-group-ggplot2)
- [Ridge plot](https://r-charts.com/distribution/ggridges/)
- [Jitter plot](https://ggplot2.tidyverse.org/reference/geom_jitter.html) 
- [Violin plot](https://r-charts.com/distribution/violin-plot-group-ggplot2) 
- [Histogram](https://r-charts.com/distribution/histogram-density-ggplot2/) 
- [Beeswarm](https://r-charts.com/distribution/beeswarm/)

Create plots displaying the distribution of lobster **counts**:

1) grouped by reef site  
2) grouped by MPA status
3) grouped by year

Create a plot of lobster **size** :

4) You choose the grouping variable(s)!
```{r}
#| fig-alt: "A ridge plot displaying the distribution of lobster counts by site. Sites are ordered reverse alphabetically. A red vertical dashed line indicates the overall mean count of approximately 25 lobsters across all sites."

spiny_counts %>% 
  mutate(site = fct_rev(site)) %>%  
  ggplot(aes(x = num_lobsters, y = site, fill = site)) +
  geom_density_ridges(alpha = 0.7) +
  scale_fill_viridis_d(option = "plasma") +
  geom_vline(xintercept = mean(spiny_counts$num_lobsters), 
             linetype = "dashed", color = "red", size = 0.5) + 
  labs(
    title = "Distribution of Lobster Counts by Site",
    x = "Number of Lobsters",
    y = "Site"
  ) +
  theme_light() +
  theme(legend.position = "none")
```

```{r}
#| fig-alt: "A violin plot with jittered points showing lobster count distribution by MPA status (MPA vs non-MPA). A red dashed horizontal line indicates the overall mean lobster count across both groups."

# 2
spiny_counts %>% 
  ggplot(aes(x = mpa, y = num_lobsters)) +
  geom_violin(fill = 'dodgerblue', alpha = 0.6) +  
  geom_jitter(width = 0.2, alpha = 0.5, size = 1.5) +  
    # Displaying median of number of lobsters
  geom_hline(aes(yintercept = mean(num_lobsters)), 
             linetype = "dashed", color = "red", size = 1) + 
  labs(
    title = "Lobster Counts by MPA Status",
    x = "Marine Protected Area (MPA) Status",
    y = "Number of Lobsters"
  ) +
  theme_light()
```

```{r}
#| fig-alt: "A beeswarm plot showing the distribution of lobster counts by year. Each point represents an observation, colored by year. A red dashed horizontal line indicates the overall median count of approximately 10 lobsters."

# 3
spiny_counts %>% 
  ggplot(aes(x = as.factor(year), y = num_lobsters, color = as.factor(year))) +
  ggbeeswarm::geom_beeswarm(alpha = 0.6, size = 2) +
  scale_color_viridis_d(option = "plasma") +
  geom_hline(yintercept = median(spiny_counts$num_lobsters), 
             linetype = "dashed", color = "red", size = 1) + 
  labs(
    title = "Lobster Count Distribution by Year",
    x = "Year",
    y = "Number of Lobsters"
  ) +
  theme_light() +
  theme(legend.position = "none")
```


```{r}
#| fig-alt: "A boxplot overlaid with beeswarm points showing the distribution of mean lobster size by site. Sites are ordered reverse alphabetically. Boxplots show median, quartiles, and range, while individual points show the distribution of observations."

spiny_counts %>% 
  mutate(site = fct_rev(site)) %>%  
  ggplot(aes(y = site, x = mean_size, fill = site)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  ggbeeswarm::geom_beeswarm(alpha = 0.4, size = 1.5) +
  scale_fill_viridis_d(option = "viridis") +
  labs(
    y = 'Site',
    x = 'Mean Size of Lobsters (mm)',
    title = "Distribution of Average Lobster Size by Site"
  ) +
  theme_light() +
  theme(legend.position = "none")
```
**c.** Compare means of the outcome by treatment group. Using the `tbl_summary()` function from the package [`gt_summary`](https://www.danieldsjoberg.com/gtsummary/articles/tbl_summary.html) 

```{r}
# USE: gt_summary::tbl_summary()
spiny_counts %>% 
  select(mpa, num_lobsters) %>% 
  tbl_summary(
    by = mpa,
    # Getting Calcs
    statistic = all_continuous() ~ "{mean} ({sd})", 
    # Better Labeling
    label = num_lobsters ~ "Number of Lobsters" 
  ) %>%
  modify_header(
    # 
    stat_1 = "**MPA**",
    stat_2 = "**Non-MPA**"
  ) %>%
  bold_labels()
```

------------------------------------------------------------------------

#### Step 4: OLS regression- building intuition

**a.** Start with a simple OLS estimator of lobster counts regressed on treatment. Use the function `summ()` from the [`jtools`](https://jtools.jacob-long.com/) package to print the OLS output

**b.** Interpret the intercept & predictor coefficients *in your own words*. Use full sentences and write your interpretation of the regression results to be as clear as possible to a non-academic audience.

```
- Intercept: On average, there are approximate 28% number of lobsters in MPA's.
- non-mpa: The model estimates a reduction of 5% number of lobsters in Non-MPA's.
```
```{r}
# NOTE: We will not evaluate/interpret model fit in this assignment (e.g., R-square)

m1_ols <- lm(num_lobsters ~ mpa, 
             data = spiny_counts)

summ(m1_ols, model.fit = FALSE) 

```

**c.** Check the model assumptions using the `check_model` function from the `performance` package

**d.** Explain the results of the 4 diagnostic plots. Why are we getting this result?
1. In the first plot, the dots do not fall within the line, and they should be generally curved around zero.
- Overall, The reason we might be getting these results is because this test might not be adequent for the data we have. Another general linear model can be used and run `check_model` functions.

```{r}
check_model(m1_ols,  check = "qq" )
```

2. The residuals fall outside of the normal curve, although it is generally close to the normal curve.
```{r}
check_model(m1_ols, check = "normality")
```

3. The reference line is not flat and horizontal, it follows the shape with variance around it.
```{r}
check_model(m1_ols, check = "homogeneity")
```

4. The model predicted data does not resemeble the spike of the observed data, however it does represent a normal distribution..
```{r}
check_model(m1_ols, check = "pp_check")
```

------------------------------------------------------------------------

#### Step 5: Fitting GLMs

**a.** Estimate a Poisson regression model using the `glm()` function

**b.** Interpret the predictor coefficient in your own words. Use full sentences and write your interpretation of the results to be as clear as possible to a non-academic audience.
- Intercept: On average, the model estimates our MPA lobster count to have 28 lobsters.
- non-mpa: The model estimate that there is a reduction of 19 lobster counts in non-mpa locations.

**c.** Explain the statistical concept of dispersion and overdispersion in the context of this model. 
- Dispersion describes how much the data can vary. If the mean number of lobsters at a site is 5, the variance is assumed to also be 5.
- Overdispersion occurs when there is more variability in the data than expected. In our model this can be represent by how the each sites ecosystem can be different.

**d.** Compare results with previous model, explain change in the significance of the treatment effect
- The difference between OLS and Poisson, is that poisson is used for modeling count outcomes and with the link function of log, it restricts values to only be positive outcomes. The OLS is used for continuous approximations to normal outcomes, assumptions are more complicated since it does not account for discrete and skewed data. In the summary the OLS SE and P Values were much higher than the poisson model, meaning they are not significant.


```{r}
#HINT1: Incidence Ratio Rate (IRR): Exponentiation of beta returns coefficient which is interpreted as the 'percent change' for a one unit increase in the predictor 

#HINT2: For the second glm() argument `family` use the following specification option `family = poisson(link = "log")`

m2_pois <-glm(num_lobsters ~ mpa,
                  family = poisson(link = "log"),# Using log for multiplicative
                  data = spiny_counts
                  )

summ(m2_pois, model.fit = FALSE)
#> exp(3.34) = 28.21
#> (exp(-0.21)-1)*100 = -18.94
```

**e.** Check the model assumptions. Explain results.
In the assumption of poisson, Not all counts fit the Poisson curve, mean â‰  dispersion (variance),and high proportion of zeros. Our results from the poisson model is that both the SE and pvalue are much smaller, meaning they are significant.

**f.** Conduct tests for over-dispersion & zero-inflation. Explain results.

When the `check_model` was ran for the `m2_pois` the figures are more accurate, although there may be another model that may be a better fit for our count data. In the results for overdispersion test we got a high ratio of 67.03. From the high ratio, we can tell that we our data has significant overdispersion. In the results for zero-inflation we have a zero predicted zeroes. Although, there are 27 observed zeros, this means that the model is underfitting zeros.  
```{r}
check_model(m2_pois)
```

```{r}
check_overdispersion(m2_pois)
```

```{r}
check_zeroinflation(m2_pois)
```

**g.** Fit a negative binomial model using the function glm.nb() from the package `MASS` and check model diagnostics 

**h.** In 1-2 sentences explain rationale for fitting this GLM model.
A negative binomial was used to model overdispersed count data, it allows to account for over or under dispersion. While it is more flexible than a poisson glm, the estimated effect suggests about a 19% reduction in lobster abundance at non-MPA sites, accounting for overdispersion increases uncertainty and not significant.

**i.** Interpret the treatment estimate result in your own words. Compare with results from the previous model.
Intercept: Our model estimates an average of 3.34% (28 count) number of lobsters to be found in MPA locations.
non-mpa: The model estimate that there is a reduction of 19% lobster counts in non-mpa locations. 
Comparing the results with the poisson model, the negative binomial fit the `check_model` very accurate. The distribution of residuals, posterior predictive check, misspecified dispersion and zero-inflation plots fall closer to each other than in the poisson model. Taking a look into the overdispersion, there is a ratio of 1.400 and a p-value of 0.064, smaller values than our previous model. The zero-inflation show the lower observed zeros and higher predicted zeros showcasing the moderate fitting of zeros in outcome.

```{r}
library(MASS) ## NOTE: The `select()` function is masked. Use: `dplyr::select()` ##
```

```{r}

# NOTE: The `glm.nb()` function does not require a `family` argument

m3_nb <- spiny_counts %>% 
    dplyr::select(num_lobsters,mpa) %>% 
    glm.nb(num_lobsters ~ mpa,
           data  = .)

summ(m3_nb, model.fit = FALSE)

```


```{r}
check_overdispersion(m3_nb)
```

```{r}
check_zeroinflation(m3_nb)
```

```{r}
check_predictions(m3_nb)
```

```{r}
check_model(m3_nb)
```


------------------------------------------------------------------------

#### Step 6: Compare models 

**a.** Use the `export_summ()` function from the `jtools` package to look at the three regression models you fit side-by-side.

**c.** Write a short paragraph comparing the results. Is the treatment effect `robust` or stable across the model specifications. 
The treatment effect is consistent across models, indicating fewer lobsters in non-MPA locations. However, the statistical significance of this effect is not robust to model choice. The Poisson model finds a highly significant negative effect, but diagnostic checks indicate overdispersion and excess zeros, which violate Poisson assumptions. When this extra variability is accounted for in the negative binomial model, SE increase and the treatment effect is no longer statistically significant. This suggests that while the estimated effect size is stable, the strength of the evidence for a treatment effect depends on the modeling assumptions.

```{r}

export_summs(# ADD MODELS
    m1_ols, m2_pois, m3_nb,
             model.names = c("OLS","Poisson", "NB"),
             statistics = "none")

```

------------------------------------------------------------------------

#### Step 7: Building intuition - fixed effects

**a.** Create  new `df` with the `year` variable converted to a factor

**b.** Run the following negative binomial model using `glm.nb()`

- Add fixed effects for `year` (i.e., dummy coefficients)
- Include an interaction term between variables `treat` & `year` (`treat*year`)

**c.** Take a look at the regression output. Each coefficient provides a comparison or the difference in means for a specific sub-group in the data. Informally, describe the what the model has estimated at a conceptual level (NOTE: you do not have to interpret coefficients individually)

**d.** Explain why the main effect for treatment is negative? *Does this result make sense?

```{r}

ff_counts <- spiny_counts %>% 
    mutate(year=as_factor(year))
    
m5_fixedeffs <- glm.nb(
    counts ~ 
        treat +
        year +
        treat*year,
    data = ff_counts)

summ(m5_fixedeffs, model.fit = FALSE)
```

**e.** Look at the model predictions: Use the `interact_plot()` function from package `interactions` to plot mean predictions by year and treatment status. 

**f.** Re-evaluate your responses (c) and (b) above. 

```{r}

interact_plot(m5_fixedeffs, pred = year, modx = treat,
              outcome.scale = "link") # NOTE: y-axis on log-scale

# HINT: Change `outcome.scale` to "response" to convert y-axis scale to counts
```

**g.** Using `ggplot()` create a plot in same style as the previous `interaction plot`, but displaying the original scale of the outcome variable (lobster counts). This type of plot is commonly used to show how the treatment effect changes across discrete time points (i.e., panel data).

The plot should have... 
- `year` on the x-axis
- `counts` on the y-axis
- `mpa` as the grouping variable


```{r}
# Hint 1: Group counts by `year` and `mpa` and calculate the `mean_count`
# Hint 2: Convert variable `year` to a factor

plot_counts <- 

# plot_counts %>% ggplot() ...
```

------------------------------------------------------------------------

#### Step 8: Reconsider causal identification assumptions

a. Discuss whether you think `spillover effects` are likely in this research context (see Glossary of terms; https://docs.google.com/document/d/1RIudsVcYhWGpqC-Uftk9UTz3PIq6stVyEpT44EPNgpE/edit?usp=sharing)
b. Explain why spillover is an issue for the identification of causal effects
c. How does spillover relate to impact in this research setting?
d. Discuss the following causal inference assumptions in the context of the MPA treatment effect estimator. Evaluate if each of the assumption are reasonable: 
    
    1) SUTVA: Stable Unit Treatment Value assumption 
    2) Excludability assumption

------------------------------------------------------------------------

# EXTRA CREDIT

> Use the recent lobster abundance data with observations collected up until 2024 (`extracredit_sblobstrs24.csv`) to run an analysis evaluating the effect of MPA status on lobster counts using the same focal variables.

a. Create a new script for the analysis on the updated data
b. Run at least 3 regression models & assess model diagnostics
c. Compare and contrast results with the analysis from the 2012-2018 data sample (~ 2 paragraphs)


------------------------------------------------------------------------

![](figures/spiny1.png)

